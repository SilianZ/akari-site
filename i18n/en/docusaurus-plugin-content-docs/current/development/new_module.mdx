---
sidebar_position: 2
---

# New Module Guide

This will teach you how to write a custom module.

:::info

You can install the `precommit` git hook before you develop. It can do some actions before submitting a commit.e.g.：Sync poetry.lock to requirements.txt, auto pep8 formatting.

:::

## Note

All modules are stored in the `modules` folder.If you want to write a new module, create a new folder here.

Folder name is not used to differentiate module names, only for classifications.

机器人在加载的时候会遍历 `modules` 文件夹，并加载每个模块文件夹里的 `__init__.py`，请将想要加入的模块定义编写在 `__init__.py` 中或确保其能够被引用。

## Prepared by

我们假设你现在写好了具体的代码，现在你想把其做成一个可以给机器人使用的功能：

### Define Module

We need to define a module type before writing the module.

```py
from core.component import module

test = module(
    bind_prefix='test1', # 定义模块名
    desc='这是一个简介', # 此模块的简介
    alias='t', # 此模块的别名
    developers=['Example'], # 开发者的名字
    recommend_modules=['test2', 'test3']), # 推荐启用的其他模块，用于在启用此模块时进行一并提示
    required_admin = False, # 将此模块标记为仅群组管理员可执行，覆盖下文所述的子命令设定，默认为False
    base = False, # 将此模块标记为基础模块，无需启用即可使用，默认为False
    required_superuser = False, # 将此模块标记为仅机器人超级管理员可使用，覆盖下文所述的子命令设定，默认为False
    support_languages=['zh_cn', 'zh_tw', 'en_us'] # 此模块支持的语言，未在列表内的语言在启用模块时会出现提醒
)
```

### Bind Module

Now that you have defined a module, you need to bind what you want.

In the previous text, we have stated the `test` variable and we will bind subcommands around the definition. To make the code simple, we have used decorator：

#### Command(general command)

```py
From core.builtins import Bot

@test. ommand(help_doc='<args1>', # syntax setting this command, prefix matching module name, Ignore it. Provide a list or tuple to handle multiple commands. Can be empty.
             required_admin = False, # Mark this command as accessible only to group administrators.
             required_superuser = False, # Mark this command as a robot superadministrator to use.
             available for = '*' # controlling the source of the message that this command can be used, Consider '*'(all)
             )
async def _(msg: Bot. essageSession:
...
```

When `help_doc` is empty, this module allows executable without syntax command.If：uses the `~test` command (nothing after) then triggers the function below the decorator, otherwise there will be a \`syntax error'.

Commands matching syntax will be stored in `msg.parsed_msg` (dict type)

e.g.：`{'<args1>': 'xx'}`

#### Regex(regular expression)

```py
From core.builtins import Bot

@test.regex(pattern=r'\[\[. ?]]', # regular expression syntax
            mode='M', # regular mode, set to 'M' match, A' matches all mode
            flags=0, # regular flags, such as Re. |Re.I
            show_typing=False # Whether to show input tips (e.g. stamps) when command is executed, Consider True
             )
async def _(msg: Bot. essageSession):
...
```

The command results matching the expression will be stored in `msg.matched_msg`.

When the commands you entered match the syntax inside `help_doc`, the robot will pass the message into the function below the decorator and you can do it.

#### Schedule (Scheduled Tasks)

```py
From core.builtins import Bot
from core.scheduler import cronTrigger

@test.schedule(trigger=CronTrigger.from_crontab('30 8 * MON')) # conditions that trigger this decorator
async def _():
...
```

#### FetchTarget

```py
From core.builtins import Bot
...
await Bot.FetchTarget. ost_message('test', 'A'h') # Push message
sender = 'QQ|123456' # QQ number 123456 friend
fetch = Bot to all users who have enabled the test module. etchTarget.fetch_target(senter) # Retrieving
if fetch: # if fetched to
    await fetch.sendMessage('xx') # send message
```

Used mainly to get user push content from the database.

### Universal Decorator

Assuming that you already use the decorator above and you are particularly lazy, you can use the Universal Decorator to replace the three decorators, which will automatically identify the condition and classify the function.

```py
From core.builtins import Bot

@test.handle('<args1>')
async def _(msg: Bot.MessageSession):
    ...


@test.handle(re.complie('). )')
async def _(msg: Bot.MessageSession):
    ...


@test. andle (CronTrigger.from_crontab('30 8 * * MON'))
async def _():
...
```

### Process Message

Our function below the decorator defines a msg parameter on which the message will be sent. We only show base methods here. For specific actions see IDE.

```py
...
send = await msg.sendMessage('Hello.') # Send a message to the sending object
send.delete() # Delete this message
...
firm = await msg.waitConfirm('Are you sure?')# will suspend execution after sending this message, waiting for the user's next message,
if confirmed: # user sent a confirmation word
...
```

Sent messages can be sent to stack or contain a list of message components, such as：`Plain('Today's Picture：'), Image('https://example.com/test.jpg')`

### Feed

The following information sources are available at this time with the following account：

-   QQ
    -   `QQQ|Group` (QQ group)
    -   `QQQ` (QQ friends)
    -   `QQQ|Guild` (QQ channel)
-   Discord
    -   \`Discord|Channel
    -   `Discord|DM|Channel (Private Channel`)
-   Telegram
    -   `Telegram|private` (Telegram private chat)
    -   `Telegram|group` (Telegram Group)
    -   `Telegram|supergroup` (Telegram supergroup(?))
    -   `Telegram|channel`(Telegram channel)
-   Kook
    -   `Kook|GROUP` (Kook channel)
-   Console
    -   `TEST|Console` (Console )

### Message Component

Currently available `Plain` (text), `Image` (image), `Voice` (voice)

### Alias

Use mainly for quick triggering commands or for compatibility with old command syntax. The alias will point to the module name when it is `str`, `List[str]`, `Tuple[str]`.

Use `~t xxx = ~test1 xxx` as above

当为 dict 时则可自定义别名映射的命令，如 `{'enable': 'module enable'}`，则 `~enable xxx` = `~module enable xxx`

### Multilingualism

We have joined multilingual support, and all multilingual files are stored in the `locales` folder in the module folder, where `en_us.json`, `en_us.json` and json files store different language keys.

Most of the public commands currently in the official repository are maintained in multiple languages by robots, and the new module needs to store `en.json` under the folder.

Multiple languages can be called in the code via `MessageSession.locale.t("Keyname")`.命令帮助则是 `{键名}` ，如 `test <arg1> {{help.test}}`。
